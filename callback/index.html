<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Yahoo OAuth Callback</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    code { background: #eee; padding: 0.2em 0.4em; }
    .success { color: green; }
    .error { color: red; }
    .info { background: #f5f5f5; padding: 1em; margin: 1em 0; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Yahoo OAuth Callback</h1>
  
  <div id="oauth-status">
    <p id="status">Processing OAuth response...</p>
    <p><strong>Authorization Code:</strong> <code id="auth-code">–</code></p>
    <p><strong>Error:</strong> <code id="error">–</code></p>
    <p><strong>Error Description:</strong> <code id="error-description">–</code></p>
  </div>

  <!-- Debug Information -->
  <div class="info">
    <h3>Debug Information</h3>
    <p><strong>Current URL:</strong> <code id="current-url"></code></p>
    <p><strong>Redirect URI:</strong> <code id="redirect-uri"></code></p>
    <p><strong>URL Parameters:</strong> <code id="url-params"></code></p>
    <p><strong>Note:</strong> Using authorization code flow (response_type=code)</p>
  </div>

  <!-- Yahoo FFB Teams Section -->
  <div id="yahoo-ffb-teams"></div>
  
  <script src="../yahoo-ffb-teams.js"></script>

  <script>
    // Display debug information
    document.getElementById("current-url").textContent = window.location.href;
    document.getElementById("redirect-uri").textContent = window.location.origin + "/callback/";
    document.getElementById("url-params").textContent = window.location.search || "No parameters";

    // Parse URL parameters for OAuth response (authorization code flow)
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const error = params.get("error");
    const errorDescription = params.get("error_description");

    // Display OAuth results
    document.getElementById("auth-code").textContent = code ? "Present (hidden for security)" : "Missing";
    document.getElementById("error").textContent = error || "None";
    document.getElementById("error-description").textContent = errorDescription || "None";

    if (code) {
      document.getElementById("status").textContent = "Authorization code received! Exchanging for access token...";
      document.getElementById("status").className = "success";
      
      // Exchange code for access token using our serverless function
      exchangeCodeForToken(code);
    } else if (error) {
      document.getElementById("status").textContent = "OAuth failed!";
      document.getElementById("status").className = "error";
    } else {
      document.getElementById("status").textContent = "No OAuth response detected.";
    }

    async function exchangeCodeForToken(code) {
      try {
        const response = await fetch('/api/oauth', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            code: code,
            redirect_uri: window.location.origin + "/callback/"
          })
        });

        const data = await response.json();

        if (response.ok) {
          // Success! Now we can fetch teams
          document.getElementById("status").textContent = "Access token received! Fetching teams...";
          fetchAndShowTeamsWithToken(data.access_token);
        } else {
          document.getElementById("status").textContent = "Token exchange failed: " + data.error;
          document.getElementById("status").className = "error";
        }
      } catch (error) {
        document.getElementById("status").textContent = "Error exchanging code: " + error.message;
        document.getElementById("status").className = "error";
      }
    }

    async function fetchAndShowTeamsWithToken(accessToken) {
      try {
        const response = await fetch('/api/fetch-teams', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            access_token: accessToken,
            league_key: '399.l.175815'
          })
        });

        const data = await response.json();
        const container = document.getElementById("yahoo-ffb-teams");
        if (!container) return;

        if (!response.ok) {
          container.innerHTML = `<div>Error fetching teams: ${data.error}</div>`;
          return;
        }

        // Display teams
        container.innerHTML = `<h2>Teams in ${data.league_name}</h2>`;
        container.innerHTML += `<p><strong>League Key:</strong> ${data.league_key}</p>`;
        data.teams.forEach((name) => {
          const div = document.createElement("div");
          div.textContent = name;
          container.appendChild(div);
        });

        document.getElementById("status").textContent = "Teams loaded successfully!";
      } catch (e) {
        document.getElementById("yahoo-ffb-teams").innerHTML = `<div>Could not fetch teams: ${e.message}</div>`;
      }
    }
  </script>
</body>
</html> 