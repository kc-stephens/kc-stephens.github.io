<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Test League Keys</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    .debug { background: #f5f5f5; padding: 1em; margin: 1em 0; border-radius: 4px; }
    .success { color: green; }
    .error { color: red; }
    .info { background: #e3f2fd; padding: 1em; margin: 1em 0; border-radius: 4px; }
    .test-result { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Test League Keys for League ID: 175815</h1>
  
  <div class="info">
    <h3>Testing Different Game Keys</h3>
    <p>We'll test different game keys with your league ID (175815) to find the correct league key.</p>
    <p>Possible combinations:</p>
    <ul>
      <li><code>399.l.175815</code> (NFL 2024)</li>
      <li><code>402.l.175815</code> (NFL 2023)</li>
      <li><code>405.l.175815</code> (NFL 2022)</li>
      <li><code>408.l.175815</code> (NFL 2021)</li>
      <li><code>411.l.175815</code> (NFL 2020)</li>
    </ul>
  </div>

  <div id="oauth-status">
    <p id="status">Processing OAuth response...</p>
    <p><strong>Authorization Code:</strong> <code id="auth-code">–</code></p>
  </div>

  <div id="test-results"></div>
  
  <script>
    // Parse URL parameters for OAuth response
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const error = params.get("error");

    document.getElementById("auth-code").textContent = code ? "Present (hidden for security)" : "Missing";

    if (code) {
      document.getElementById("status").textContent = "Authorization successful! Testing league keys...";
      document.getElementById("status").className = "success";
      exchangeCodeAndTestLeagues(code);
    } else if (error) {
      document.getElementById("status").textContent = "OAuth failed: " + error;
      document.getElementById("status").className = "error";
    } else {
      document.getElementById("status").textContent = "No OAuth response detected.";
    }

    async function exchangeCodeAndTestLeagues(code) {
      try {
        // Exchange code for access token
        const response = await fetch('/api/oauth', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            code: code,
            redirect_uri: window.location.origin + "/test-league-keys/"
          })
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById("status").textContent = "Access token received! Testing league keys...";
          testAllLeagueKeys(data.access_token);
        } else {
          document.getElementById("status").textContent = "Token exchange failed: " + data.error;
          document.getElementById("status").className = "error";
        }
      } catch (error) {
        document.getElementById("status").textContent = "Error exchanging code: " + error.message;
        document.getElementById("status").className = "error";
      }
    }

    async function testAllLeagueKeys(accessToken) {
      const leagueKeys = [
        '399.l.175815', // NFL 2024
        '402.l.175815', // NFL 2023
        '405.l.175815', // NFL 2022
        '408.l.175815', // NFL 2021
        '411.l.175815'  // NFL 2020
      ];

      const resultsDiv = document.getElementById("test-results");
      resultsDiv.innerHTML = "<h2>Testing League Keys</h2>";

      for (const leagueKey of leagueKeys) {
        try {
          const response = await fetch('/api/fetch-teams', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              access_token: accessToken,
              league_key: leagueKey
            })
          });

          const data = await response.json();
          const div = document.createElement("div");
          div.className = "test-result";

          if (response.ok) {
            div.innerHTML = `
              <h3>✅ ${leagueKey} - SUCCESS</h3>
              <p><strong>League Name:</strong> ${data.league_name}</p>
              <p><strong>Teams Found:</strong> ${data.teams.length}</p>
              <p><strong>Teams:</strong> ${data.teams.join(', ')}</p>
            `;
            div.style.borderColor = "green";
          } else {
            div.innerHTML = `
              <h3>❌ ${leagueKey} - FAILED</h3>
              <p><strong>Error:</strong> ${data.error}</p>
              <p><strong>Status:</strong> ${data.status}</p>
            `;
            div.style.borderColor = "red";
          }

          resultsDiv.appendChild(div);
        } catch (error) {
          const div = document.createElement("div");
          div.className = "test-result";
          div.innerHTML = `
            <h3>❌ ${leagueKey} - ERROR</h3>
            <p><strong>Error:</strong> ${error.message}</p>
          `;
          div.style.borderColor = "red";
          resultsDiv.appendChild(div);
        }
      }

      document.getElementById("status").textContent = "League key testing complete!";
    }
  </script>
</body>
</html> 